import{dom,qs$}from"./dom.js";import{fetchJSON}from"./fetch.js";import{getEnabledRulesetsDetails}from"./ruleset-manager.js";import{i18n$}from"./i18n.js";import{sendMessage}from"./ext.js";import{urlSkip}from"./urlskip.js";const rulesetDetailsPromise=getEnabledRulesetsDetails();function urlToFragment(e){try{const t=new DocumentFragment,n=new URL(e).hostname,o=e.indexOf(n),s=document.createElement("b");return s.append(n),t.append(e.slice(0,o),s,e.slice(o+n.length)),t}catch(e){}return e}const toURL=new URL("about:blank"),toFinalURL=new URL("about:blank");try{toURL.href=self.location.hash.slice(1),toFinalURL.href=toURL.href}catch(e){}async function proceed(){const e=qs$("#disableWarning").checked;if(toFinalURL.hostname!==toURL.hostname&&!0!==e)return window.location.replace(toFinalURL.href);await sendMessage({what:"excludeFromStrictBlock",hostname:toURL.hostname,permanent:e}),window.location.replace(toURL.href)}function fragmentFromTemplate(e,t,n,o){const s=new DocumentFragment,r=e.indexOf(t);if(-1===r)return s.append(e),s;const a=document.createElement(o.tag),{attributes:i}=o;if(i)for(let e=0;e<i.length;e+=2)a.setAttribute(i[e+0],i[e+1]);return a.append(n),s.append(e.slice(0,r),a,e.slice(r+t.length)),s}dom.clear("#theURL > p > span:first-of-type"),qs$("#theURL > p > span:first-of-type").append(urlToFragment(toURL.href)),(()=>{const e=/^https?:\/\//,t=function(t,n){""===n&&(n=t,t="");const o=dom.create("li");let s=dom.create("span");if(dom.text(s,t),o.appendChild(s),""!==t&&""!==n&&o.appendChild(document.createTextNode(" = ")),s=dom.create("span"),e.test(n)){const e=dom.create("a");dom.attr(e,"href",n),dom.text(e,n),s.appendChild(e)}else dom.text(s,n);return o.appendChild(s),o},n=function(o,s,r=0){let a;try{a=new URL(s)}catch(e){return!1}const i=a.search.slice(1);if(""===i)return!1;a.search="";const c=t(i18n$("strictblockNoParamsPrompt"),a.href);o.appendChild(c);const l=new self.URLSearchParams(i);for(const[s,a]of l){const i=t(s,a);if(r<2&&e.test(a)){const e=dom.create("ul");n(e,a,r+1),i.appendChild(e)}o.appendChild(i)}return!0};!1!==n(qs$("#parsed"),toURL.href)&&(dom.cl.remove("#toggleParse","hidden"),dom.on("#toggleParse","click",(()=>{dom.cl.toggle("#theURL","collapsed")})))})(),(async()=>{const e=await rulesetDetailsPromise;let t=-1;const n=async n=>{if(-1!==t)return;const o=await fetchJSON(`/rulesets/strictblock/${e[n].id}`);if(-1!==t)return;const s=toURL.href;for(const e of o){const{regexFilter:o,requestDomains:r}=e.condition;let a=void 0===r;if(r){let e=toURL.hostname;for(;;){if(r.includes(e)){a=!0;break}const t=e.indexOf(".");if(-1===t)break;e=e.slice(t+1)}if(!1===a)continue}const i=new RegExp(o).test(s);a&&i&&(t=n)}},o=[];for(let t=0;t<e.length;t++)0!==e[t].rules.strictblock&&o.push(n(t));if(0===o.length)return;if(await Promise.all(o),-1===t)return;const s=fragmentFromTemplate(i18n$("strictblockReasonSentence1"),"{{listname}}",e[t].name,{tag:"q"});qs$("#reason").append(s),dom.attr("#reason","hidden",null)})(),(async()=>{const e=await rulesetDetailsPromise,t=[];for(const n of e)0!==n.rules.urlskip&&t.push(fetchJSON(`/rulesets/urlskip/${n.id}`));if(0===t.length)return;const n=await Promise.all(t),o=toURL.hostname,s=e=>!1!==e.endsWith(o)&&(e.length===o.length||"."===o.charAt(o.length-e.length-1));for(const e of n)for(const t of e){if(!1===new RegExp(t.re,t.c?void 0:"i").test(toURL.href))continue;if(t.hostnames&&!1===t.hostnames.some((e=>s(e))))continue;const e=urlSkip(toURL.href,!1,t.steps);if(void 0===e)continue;toFinalURL.href=e;const n=fragmentFromTemplate(i18n$("strictblockRedirectSentence1"),"{{url}}",urlToFragment(e),{tag:"a",attributes:["href",e,"class","code"]});return qs$("#urlskip").append(n),void dom.attr("#urlskip","hidden",null)}})(),window.history.length>1?(dom.on("#back","click",(()=>{window.history.back()})),qs$("#bye").style.display="none"):(dom.on("#bye","click",(()=>{window.close()})),qs$("#back").style.display="none"),dom.on("#disableWarning","change",(e=>{const t=e.target.checked;dom.cl.toggle('[data-i18n="strictblockBack"]',"disabled",t),dom.cl.toggle('[data-i18n="strictblockClose"]',"disabled",t)})),dom.on("#proceed","click",(()=>{proceed()})),dom.cl.remove(dom.body,"loading");