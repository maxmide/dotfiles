import{browser,localRead,localWrite,runtime,sendMessage}from"./ext.js";import{dom,qs$}from"./dom.js";import{i18n,i18n$}from"./i18n.js";import punycode from"./punycode.js";const popupPanelData={},currentTab={},tabURL=new URL(runtime.getURL("/"));function normalizedHostname(e){return e.replace(/^www\./,"")}function renderAdminRules(){const{disabledFeatures:e=[]}=popupPanelData;0!==e.length&&(dom.body.dataset.forbid=e.join(" "))}const BLOCKING_MODE_MAX=3;function setFilteringMode(e,t=!1){qs$(".filteringModeSlider").dataset.level=e,null===qs$(".filteringModeSlider.moving")&&dom.text("#filteringModeText > span:nth-of-type(1)",i18n$(`filteringMode${e}Name`)),!0===t&&commitFilteringMode()}async function commitFilteringMode(){if(""===tabURL.hostname)return;const e=normalizedHostname(tabURL.hostname),t=qs$(".filteringModeSlider"),o=parseInt(t.dataset.level,10),n=parseInt(t.dataset.levelBefore,10);if(o>1){let t=!1;try{t=await browser.permissions.request({origins:[`*://*.${e}/*`]})}catch(e){}if(!0!==t)return void setFilteringMode(n)}dom.text("#filteringModeText > span:nth-of-type(1)",i18n$(`filteringMode${o}Name`));const i=await sendMessage({what:"setFilteringMode",hostname:e,level:o});i!==o&&setFilteringMode(i),i!==n&&popupPanelData.autoReload&&self.setTimeout((()=>{browser.tabs.update(currentTab.id,{url:tabURL.href})}),437)}{let e,t=0,o=0,n=0,i=0;const r=()=>{e=void 0;const r=Math.min(Math.max(n+o-t,0),i);let a=Math.floor(3*r/i);null!==qs$('body[dir="rtl"]')&&(a=3-a);`${a}`!==qs$(".filteringModeSlider").dataset.level&&(dom.text("#filteringModeText > span:nth-of-type(2)",i18n$(`filteringMode${a}Name`)),setFilteringMode(a))},a=t=>{void 0===e&&(o=t.pageX,e=self.requestAnimationFrame(r))},s=t=>{if(0!==t.button)return;const o=qs$(".filteringModeSlider");!1!==dom.cl.has(o,"moving")&&(dom.cl.remove(o,"moving"),self.removeEventListener("mousemove",a,{capture:!0}),self.removeEventListener("mouseup",s,{capture:!0}),dom.text("#filteringModeText > span:nth-of-type(2)",""),commitFilteringMode(),t.stopPropagation(),t.preventDefault(),void 0!==e&&(self.cancelAnimationFrame(e),e=void 0))},l=e=>{if(0!==e.button)return;const o=qs$(".filteringModeButton");if(e.currentTarget!==o)return;const r=qs$(".filteringModeSlider");if(dom.cl.has(r,"moving"))return;r.dataset.levelBefore=r.dataset.level,t=e.pageX;const l=o.getBoundingClientRect();n=l.left+l.width/2;const d=r.getBoundingClientRect();i=d.width-l.width,dom.cl.add(r,"moving"),self.addEventListener("mousemove",a,{capture:!0}),self.addEventListener("mouseup",s,{capture:!0}),e.stopPropagation(),e.preventDefault()};dom.on(".filteringModeButton","mousedown",l)}dom.on(".filteringModeSlider","click",".filteringModeSlider span[data-level]",(e=>{const t=qs$(".filteringModeSlider");t.dataset.levelBefore=t.dataset.level;const o=e.target;setFilteringMode(parseInt(o.dataset.level,10),!0)})),dom.on(".filteringModeSlider","mouseenter",".filteringModeSlider span[data-level]",(e=>{const t=e.target,o=parseInt(t.dataset.level,10);dom.text("#filteringModeText > span:nth-of-type(2)",i18n$(`filteringMode${o}Name`))})),dom.on(".filteringModeSlider","mouseleave",".filteringModeSlider span[data-level]",(()=>{dom.text("#filteringModeText > span:nth-of-type(2)","")}));const maxNumberOfSections=2,sectionBitsFromAttribute=function(){const e=dom.body.dataset.section;if(""===e)return 0;let t=0;for(const o of e.split(" "))t|=1<<o.charCodeAt(0)-97;return t},sectionBitsToAttribute=function(e){if("number"!=typeof e)return;if(isNaN(e))return;const t=[];for(let o=0;o<2;o++){0!=(e&1<<o)&&t.push(String.fromCharCode(97+o))}dom.body.dataset.section=t.join(" ")};async function toggleSections(e){let t=sectionBitsFromAttribute(),o=t;for(let n=0;n<2;n++){const i=1<<(e?n:2-n-1);if(e?o|=i:o&=~i,o!==t)break}o!==t&&(sectionBitsToAttribute(o),localWrite("popupPanelSections",o))}async function init(){const[e]=await browser.tabs.query({active:!0,currentWindow:!0});if(e instanceof Object==!1)return!0;let t;Object.assign(currentTab,e);try{const e=runtime.getURL("/strictblock.");t=new URL(currentTab.url),t.href.startsWith(e)&&(t=new URL(t.hash.slice(1))),tabURL.href=t.href||""}catch(e){}if(void 0!==t){const e=await sendMessage({what:"popupPanelData",origin:t.origin,hostname:normalizedHostname(tabURL.hostname)});e instanceof Object&&Object.assign(popupPanelData,e)}renderAdminRules(),setFilteringMode(popupPanelData.level),dom.text("#hostname",punycode.toUnicode(tabURL.hostname)),dom.cl.toggle("#showMatchedRules","enabled",!0===popupPanelData.isSideloaded&&popupPanelData.developerMode&&"number"==typeof currentTab.id&&!1===isNaN(currentTab.id)),dom.cl.toggle("#reportFilterIssue","enabled",/^https?:\/\//.test(t?.href));const o=qs$("#rulesetStats");for(const e of popupPanelData.rulesetDetails||[]){const t=dom.clone("#templates .rulesetDetails");qs$(t,"h1").append(i18n.patchUnicodeFlags(e.name));const{rules:n,filters:i,css:r}=e;let a=n.plain+n.regex;popupPanelData.hasOmnipotence&&(a+=n.removeparam+n.redirect+n.modifyHeaders);let s=0;"number"==typeof r.specific&&(s+=r.specific),"number"==typeof r.declarative&&(s+=r.declarative),"number"==typeof r.procedural&&(s+=r.procedural),dom.text(qs$(t,"p"),i18n$("perRulesetStats").replace("{{ruleCount}}",a.toLocaleString()).replace("{{filterCount}}",i.accepted.toLocaleString()).replace("{{cssSpecificCount}}",s.toLocaleString())),o.append(t)}return dom.cl.remove(dom.body,"loading"),!0}async function tryInit(){try{await init()}catch(e){setTimeout(tryInit,100)}}localRead("popupPanelSections").then((e=>{sectionBitsToAttribute(e||0)})),dom.on("#moreButton","click",(()=>{toggleSections(!0)})),dom.on("#lessButton","click",(()=>{toggleSections(!1)})),dom.on("#showMatchedRules","click",(e=>{!0===e.isTrusted&&0===e.button&&sendMessage({what:"showMatchedRules",tabId:currentTab.id})})),dom.on('[data-i18n-title="popupTipReport"]',"click",(e=>{if(!0!==e.isTrusted)return;let t;try{t=new URL(currentTab.url)}catch(e){}if(void 0===t)return;const o=new URL(runtime.getURL("/report.html"));o.searchParams.set("url",t.href),o.searchParams.set("mode",popupPanelData.level),sendMessage({what:"gotoURL",url:`${o.pathname}${o.search}`})})),dom.on('[data-i18n-title="popupTipDashboard"]',"click",(e=>{!0===e.isTrusted&&e.button})),tryInit();