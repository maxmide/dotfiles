import{browser,sendMessage}from"./ext.js";import{dom,qs$}from"./dom.js";import punycode from"./punycode.js";import{renderFilterLists}from"./filter-lists.js";let cachedRulesetData={};function hashFromIterable(e){return Array.from(e).sort().join("\n")}function renderAdminRules(){const{disabledFeatures:e=[]}=cachedRulesetData;0!==e.length&&(dom.body.dataset.forbid=e.join(" "),e.includes("dashboard")&&(dom.body.dataset.pane="about"))}function renderWidgets(){cachedRulesetData.firstRun&&dom.cl.add(dom.body,"firstRun"),renderDefaultMode(),renderTrustedSites(),qs$('#autoReload input[type="checkbox"]').checked=cachedRulesetData.autoReload;{const e=qs$('#showBlockedCount input[type="checkbox"]');cachedRulesetData.canShowBlockedCount?e.checked=cachedRulesetData.showBlockedCount:(e.checked=!1,dom.attr(e,"disabled",""))}{const e=qs$('#strictBlockMode input[type="checkbox"]'),t=cachedRulesetData.defaultFilteringMode>1;e.checked=t&&cachedRulesetData.strictBlockMode,dom.attr(e,"disabled",t?null:"")}dom.prop('#developerMode input[type="checkbox"]',"checked",Boolean(cachedRulesetData.developerMode)),cachedRulesetData.isSideloaded&&dom.attr("#developerMode","hidden",null)}function renderDefaultMode(){const e=cachedRulesetData.defaultFilteringMode;0!==e?qs$(`.filteringModeCard input[type="radio"][value="${e}"]`).checked=!0:dom.prop('.filteringModeCard input[type="radio"]',"checked",!1)}async function onFilteringModeChange(e){const t=e.target,s=parseInt(t.value,10);switch(s){case 1:cachedRulesetData.defaultFilteringMode=1;break;case 2:case 3:if(await browser.permissions.request({origins:["<all_urls>"]})){const e=await sendMessage({what:"setDefaultFilteringMode",level:s});cachedRulesetData.defaultFilteringMode=e}break}renderFilterLists(cachedRulesetData),renderWidgets()}function renderTrustedSites(){const e=qs$("#trustedSites"),t=cachedRulesetData.trustedSites||[];e.value=t.map((e=>punycode.toUnicode(e))).join("\n"),""!==e.value&&(e.value+="\n")}function changeTrustedSites(){const e=getStagedTrustedSites(),t=hashFromIterable(cachedRulesetData.trustedSites||[]);hashFromIterable(e)!==t&&sendMessage({what:"setTrustedSites",hostnames:e})}function getStagedTrustedSites(){return qs$("#trustedSites").value.split(/\s/).map((e=>{try{return punycode.toASCII(new URL(`https://${e}/`).hostname)}catch(e){}return""})).filter((e=>""!==e))}function listen(){new self.BroadcastChannel("uBOL").onmessage=listen.onmessage}dom.on("#defaultFilteringMode","change",'.filteringModeCard input[type="radio"]',(e=>{onFilteringModeChange(e)})),dom.on('#autoReload input[type="checkbox"]',"change",(e=>{sendMessage({what:"setAutoReload",state:e.target.checked})})),dom.on('#showBlockedCount input[type="checkbox"]',"change",(e=>{sendMessage({what:"setShowBlockedCount",state:e.target.checked})})),dom.on('#strictBlockMode input[type="checkbox"]',"change",(e=>{sendMessage({what:"setStrictBlockMode",state:e.target.checked})})),dom.on('#developerMode input[type="checkbox"]',"change",(e=>{sendMessage({what:"setDeveloperMode",state:e.target.checked})})),dom.on("#trustedSites","blur",changeTrustedSites),self.addEventListener("beforeunload",changeTrustedSites),listen.onmessage=e=>{const t=e.data;if(t instanceof Object==!1)return;const s=cachedRulesetData;let a=!1;if(void 0!==t.trustedSites&&hashFromIterable(t.trustedSites)!==hashFromIterable(s.trustedSites)){const e=new Set(s.trustedSites),d=new Set(getStagedTrustedSites());for(const t of d)!1!==e.has(t)&&d.delete(t);const o=Array.from(new Set([...t.trustedSites,...d]));s.trustedSites=o,a=!0}void 0!==t.defaultFilteringMode&&t.defaultFilteringMode!==s.defaultFilteringMode&&(s.defaultFilteringMode=t.defaultFilteringMode,a=!0),void 0!==t.autoReload&&t.autoReload!==s.autoReload&&(s.autoReload=t.autoReload,a=!0),void 0!==t.showBlockedCount&&t.showBlockedCount!==s.showBlockedCount&&(s.showBlockedCount=t.showBlockedCount,a=!0),void 0!==t.strictBlockMode&&t.strictBlockMode!==s.strictBlockMode&&(s.strictBlockMode=t.strictBlockMode,a=!0),void 0!==t.adminRulesets&&hashFromIterable(t.adminRulesets)!==hashFromIterable(s.adminRulesets)&&(s.adminRulesets=t.adminRulesets,a=!0),void 0!==t.enabledRulesets&&hashFromIterable(t.enabledRulesets)!==hashFromIterable(s.enabledRulesets)&&(s.enabledRulesets=t.enabledRulesets,a=!0),!1!==a&&(renderFilterLists(cachedRulesetData),renderWidgets())},sendMessage({what:"getOptionsPageData"}).then((e=>{if(e){cachedRulesetData=e;try{renderAdminRules(),renderFilterLists(cachedRulesetData),renderWidgets(),dom.cl.remove(dom.body,"loading")}catch(e){}listen()}})).catch((e=>{console.trace(e)}));