import*as ut from"./utils.js";import{browser}from"./ext.js";import{fetchJSON}from"./fetch.js";import{getEnabledRulesetsDetails}from"./ruleset-manager.js";import{getFilteringModeDetails}from"./mode-manager.js";import{ubolLog}from"./debug.js";const isGecko=browser.runtime.getURL("").startsWith("moz-extension://"),resourceDetailPromises=new Map;function getScriptletDetails(){let e=resourceDetailPromises.get("scriptlet");return void 0!==e||(e=fetchJSON("/rulesets/scriptlet-details").then((e=>new Map(e))),resourceDetailPromises.set("scriptlet",e)),e}function getGenericDetails(){let e=resourceDetailPromises.get("generic");return void 0!==e||(e=fetchJSON("/rulesets/generic-details").then((e=>new Map(e))),resourceDetailPromises.set("generic",e)),e}const arrayEq=(e=[],s=[],t=!0)=>{const r=e.length;if(r!==s.length)return!1;t&&(e.sort(),s.sort());for(let t=0;t<r;t++)if(e[t]!==s[t])return!1;return!0},normalizeRegisteredContentScripts=e=>{for(const s of e){const{css:e=[],js:t=[]}=s;for(let s=0;s<e.length;s++){const t=e[s];t.startsWith("/")||(e[s]=`/${t}`)}for(let e=0;e<t.length;e++){const s=t[e];s.startsWith("/")||(t[e]=`/${s}`)}}return e};function registerHighGeneric(e,s){const{before:t,filteringModeDetails:r,rulesetsDetails:c}=e,o=[],i=[];for(const e of c){const t=s.get(e.id);void 0!==t&&o.push(...t);0!==(e.css?.generichigh||0)&&i.push(`/rulesets/scripting/generichigh/${e.id}.css`)}if(0===i.length)return;const{none:a,basic:n,optimal:l,complete:u}=r,h=[],m=[];if(u.has("all-urls")?(m.push(...ut.matchesFromHostnames(a)),m.push(...ut.matchesFromHostnames(n)),m.push(...ut.matchesFromHostnames(l)),m.push(...ut.matchesFromHostnames(o)),h.push("<all_urls>")):h.push(...ut.matchesFromHostnames(ut.subtractHostnameIters(Array.from(u),o))),0===h.length)return;const p=t.get("css-generichigh");t.delete("css-generichigh");const d={id:"css-generichigh",css:i,matches:h,excludeMatches:m,runAt:"document_end"};void 0!==p?!1!==arrayEq(p.css,i,!1)&&!1!==arrayEq(p.matches,h)&&!1!==arrayEq(p.excludeMatches,m)||(e.toRemove.push("css-generichigh"),e.toAdd.push(d)):e.toAdd.push(d)}function registerGeneric(e,s){const{before:t,filteringModeDetails:r,rulesetsDetails:c}=e,o=[],i=[];for(const e of c){const t=s.get(e.id);void 0!==t&&o.push(...t);0!==(e.css?.generic||0)&&i.push(`/rulesets/scripting/generic/${e.id}.js`)}if(0===i.length)return;i.push("/js/scripting/css-generic.js");const{none:a,basic:n,optimal:l,complete:u}=r,h=[],m=[];if(u.has("all-urls")?(m.push(...ut.matchesFromHostnames(a)),m.push(...ut.matchesFromHostnames(n)),m.push(...ut.matchesFromHostnames(l)),m.push(...ut.matchesFromHostnames(o)),h.push("<all_urls>")):h.push(...ut.matchesFromHostnames(ut.subtractHostnameIters(Array.from(u),o))),0===h.length)return;const p=t.get("css-generic");t.delete("css-generic");const d={id:"css-generic",js:i,matches:h,excludeMatches:m,runAt:"document_idle"};void 0!==p?!1!==arrayEq(p.js,i,!1)&&!1!==arrayEq(p.matches,h)&&!1!==arrayEq(p.excludeMatches,m)||(e.toRemove.push("css-generic"),e.toAdd.push(d)):e.toAdd.push(d)}function registerProcedural(e){const{before:s,filteringModeDetails:t,rulesetsDetails:r}=e,c=[];for(const e of r){0!==(e.css?.procedural||0)&&c.push(`/rulesets/scripting/procedural/${e.id}.js`)}if(0===c.length)return;const{none:o,basic:i,optimal:a,complete:n}=t,l=[...ut.matchesFromHostnames(a),...ut.matchesFromHostnames(n)];if(0===l.length)return;c.push("/js/scripting/css-procedural.js");const u=[];!1===o.has("all-urls")&&u.push(...ut.matchesFromHostnames(o)),!1===i.has("all-urls")&&u.push(...ut.matchesFromHostnames(i));const h=s.get("css-procedural");s.delete("css-procedural");const m={id:"css-procedural",js:c,allFrames:!0,matches:l,excludeMatches:u,runAt:"document_start"};void 0!==h?!1!==arrayEq(h.js,c,!1)&&!1!==arrayEq(h.matches,l)&&!1!==arrayEq(h.excludeMatches,u)||(e.toRemove.push("css-procedural"),e.toAdd.push(m)):e.toAdd.push(m)}function registerDeclarative(e){const{before:s,filteringModeDetails:t,rulesetsDetails:r}=e,c=[];for(const e of r){0!==(e.css?.declarative||0)&&c.push(`/rulesets/scripting/declarative/${e.id}.js`)}if(0===c.length)return;const{none:o,basic:i,optimal:a,complete:n}=t,l=[...ut.matchesFromHostnames(a),...ut.matchesFromHostnames(n)];if(0===l.length)return;c.push("/js/scripting/css-declarative.js");const u=[];!1===o.has("all-urls")&&u.push(...ut.matchesFromHostnames(o)),!1===i.has("all-urls")&&u.push(...ut.matchesFromHostnames(i));const h=s.get("css-declarative");s.delete("css-declarative");const m={id:"css-declarative",js:c,allFrames:!0,matches:l,excludeMatches:u,runAt:"document_start"};void 0!==h?!1!==arrayEq(h.js,c,!1)&&!1!==arrayEq(h.matches,l)&&!1!==arrayEq(h.excludeMatches,u)||(e.toRemove.push("css-declarative"),e.toAdd.push(m)):e.toAdd.push(m)}function registerSpecific(e){const{before:s,filteringModeDetails:t,rulesetsDetails:r}=e,c=[];for(const e of r){0!==(e.css?.specific||0)&&c.push(`/rulesets/scripting/specific/${e.id}.js`)}if(0===c.length)return;const{none:o,basic:i,optimal:a,complete:n}=t,l=[...ut.matchesFromHostnames(a),...ut.matchesFromHostnames(n)];if(0===l.length)return;c.push("/js/scripting/css-specific.js");const u=[];!1===o.has("all-urls")&&u.push(...ut.matchesFromHostnames(o)),!1===i.has("all-urls")&&u.push(...ut.matchesFromHostnames(i));const h=s.get("css-specific");s.delete("css-specific");const m={id:"css-specific",js:c,allFrames:!0,matches:l,excludeMatches:u,runAt:"document_start"};void 0!==h?!1!==arrayEq(h.js,c,!1)&&!1!==arrayEq(h.matches,l)&&!1!==arrayEq(h.excludeMatches,u)||(e.toRemove.push("css-specific"),e.toAdd.push(m)):e.toAdd.push(m)}function registerScriptlet(e,s){const{before:t,filteringModeDetails:r,rulesetsDetails:c}=e,o=r.optimal.has("all-urls")||r.complete.has("all-urls"),i=[...ut.matchesFromHostnames(r.none),...ut.matchesFromHostnames(r.basic)],a=[...r.optimal,...r.complete];for(const r of c.map((e=>e.id))){const c=s.get(r);if(void 0!==c)for(const[s,n]of c){const c=`${r}.${s}`,l=t.get(c),u=[],h=[];let m=[];if(o?(h.push(...i),m=n.length>100?["*"]:n):0!==a.length&&(m=n.includes("*")?a:ut.intersectHostnameIters(n,a)),0===m.length)continue;u.push(...ut.matchesFromHostnames(m)),t.delete(c);const p={id:c,js:[`/rulesets/scripting/scriptlet/${c}.js`],allFrames:!0,matches:u,excludeMatches:h,runAt:"document_start"};!1===isGecko&&(p.world="MAIN",p.matchOriginAsFallback=!0),void 0!==l?!1!==arrayEq(l.matches,u)&&!1!==arrayEq(l.excludeMatches,h)||(e.toRemove.push(c),e.toAdd.push(p)):e.toAdd.push(p)}}}async function registerInjectables(e){if(void 0===browser.scripting)return!1;const[s,t,r,c,o]=await Promise.all([getFilteringModeDetails(),getEnabledRulesetsDetails(),getScriptletDetails(),getGenericDetails(),browser.scripting.getRegisteredContentScripts()]),i=["workerBlockScript","splitPersonalityScript","locationWarpScript","languageWarpScript","timeZoneWarpScript"],a=new Map(normalizeRegisteredContentScripts(o.filter((e=>!i.includes(e.id)))).map((e=>[e.id,e]))),n=[],l=[],u={filteringModeDetails:s,rulesetsDetails:t,before:a,toAdd:n,toRemove:l};return registerDeclarative(u),registerProcedural(u),registerScriptlet(u,r),registerSpecific(u),registerGeneric(u,c),registerHighGeneric(u,c),l.push(...Array.from(a.keys())),0!==l.length&&(ubolLog(`Unregistered ${l} content (css/js)`),await browser.scripting.unregisterContentScripts({ids:l}).catch((e=>{console.info(e)}))),0!==n.length&&(ubolLog(`Registered ${n.map((e=>e.id))} content (css/js)`),await browser.scripting.registerContentScripts(n).catch((e=>{console.info(e)}))),!0}export{registerInjectables};