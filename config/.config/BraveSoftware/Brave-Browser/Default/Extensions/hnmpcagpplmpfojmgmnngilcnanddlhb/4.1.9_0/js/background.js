import{MODE_BASIC,MODE_OPTIMAL,getDefaultFilteringMode,getFilteringMode,getTrustedSites,setDefaultFilteringMode,setFilteringMode,setTrustedSites,syncWithBrowserPermissions}from"./mode-manager.js";import{adminRead,browser,dnr,localRead,localRemove,localWrite,runtime,windows}from"./ext.js";import{adminReadEx,getAdminRulesets}from"./admin.js";import{enableRulesets,excludeFromStrictBlock,getEnabledRulesetsDetails,getRulesetDetails,patchDefaultRulesets,setStrictBlockMode,updateDynamicRules,updateSessionRules}from"./ruleset-manager.js";import{getMatchedRules,isSideloaded,toggleDeveloperMode,ubolLog}from"./debug.js";import{loadRulesetConfig,process,rulesetConfig,saveRulesetConfig}from"./config.js";import{broadcastMessage}from"./utils.js";import{registerInjectables}from"./scripting-manager.js";const UBOL_ORIGIN=runtime.getURL("").replace(/\/$/,""),canShowBlockedCount="function"==typeof dnr.setExtensionActionOptions;function getCurrentVersion(){return runtime.getManifest().version}async function hasGreatPowers(e){return!1!==/^https?:\/\//.test(e)&&browser.permissions.contains({origins:[`${e}/*`]})}async function hasOmnipotence(){const e=runtime.getManifest();return!(!Array.isArray(e.host_permissions)||!e.host_permissions.includes("<all_urls>"))||browser.permissions.contains({origins:["<all_urls>"]})}async function onPermissionsRemoved(){const e=await getDefaultFilteringMode();if(!1===await syncWithBrowserPermissions())return!1;const t=await getDefaultFilteringMode();return e>MODE_BASIC&&t<=MODE_BASIC&&updateDynamicRules(),registerInjectables(),!0}async function gotoURL(e,t){const s=new URL(e,runtime.getURL("/")),o=await browser.tabs.query({url:s.href,windowType:"popup"!==t?"normal":"popup"});if(Array.isArray(o)&&0!==o.length){const{windowId:e,id:t}=o[0];return Promise.all([browser.windows.update(e,{focused:!0}),browser.tabs.update(t,{active:!0})])}return"popup"===t?windows.create({type:"popup",url:s.href}):browser.tabs.create({active:!0,url:s.href})}function onMessage(e,t,s){if("insertCSS"===e.what){const s=t?.tab?.id??!1,o=t?.frameId??!1;if(!1===s||!1===o)return;return browser.scripting.insertCSS({css:e.css,origin:"USER",target:{tabId:s,frameIds:[o]}}).catch((e=>{console.log(e)})),!1}if(void 0===t.origin||t.origin===UBOL_ORIGIN){switch(e.what){case"applyRulesets":return enableRulesets(e.enabledRulesets).then((()=>(rulesetConfig.enabledRulesets=e.enabledRulesets,saveRulesetConfig()))).then((()=>(registerInjectables(),s(),dnr.getEnabledRulesets()))).then((e=>{broadcastMessage({enabledRulesets:e})})),!0;case"getOptionsPageData":return Promise.all([getDefaultFilteringMode(),getTrustedSites(),getRulesetDetails(),dnr.getEnabledRulesets(),getAdminRulesets(),adminReadEx("disabledFeatures")]).then((e=>{const[t,o,r,n,a,i]=e;s({defaultFilteringMode:t,trustedSites:Array.from(o),enabledRulesets:n,adminRulesets:a,maxNumberOfEnabledRulesets:dnr.MAX_NUMBER_OF_ENABLED_STATIC_RULESETS,rulesetDetails:Array.from(r.values()),autoReload:rulesetConfig.autoReload,showBlockedCount:rulesetConfig.showBlockedCount,canShowBlockedCount,strictBlockMode:rulesetConfig.strictBlockMode,firstRun:process.firstRun,isSideloaded,developerMode:rulesetConfig.developerMode,disabledFeatures:i}),process.firstRun=!1})),!0;case"setAutoReload":return rulesetConfig.autoReload=!!e.state,saveRulesetConfig().then((()=>{s(),broadcastMessage({autoReload:rulesetConfig.autoReload})})),!0;case"setShowBlockedCount":return rulesetConfig.showBlockedCount=!!e.state,saveRulesetConfig().then((()=>{s(),broadcastMessage({showBlockedCount:rulesetConfig.showBlockedCount})})),!0;case"setStrictBlockMode":return setStrictBlockMode(e.state).then((()=>{s(),broadcastMessage({strictBlockMode:rulesetConfig.strictBlockMode})})),!0;case"setDeveloperMode":return rulesetConfig.developerMode=e.state,toggleDeveloperMode(rulesetConfig.developerMode),saveRulesetConfig().then((()=>{s()})),!0;case"popupPanelData":return Promise.all([getFilteringMode(e.hostname),hasOmnipotence(),hasGreatPowers(e.origin),getEnabledRulesetsDetails(),adminReadEx("disabledFeatures")]).then((e=>{s({level:e[0],autoReload:rulesetConfig.autoReload,hasOmnipotence:e[1],hasGreatPowers:e[2],rulesetDetails:e[3],isSideloaded,developerMode:rulesetConfig.developerMode,disabledFeatures:e[4]})})),!0;case"getFilteringMode":return getFilteringMode(e.hostname).then((e=>{s(e)})),!0;case"gotoURL":gotoURL(e.url,e.type);break;case"setFilteringMode":return getFilteringMode(e.hostname).then((t=>e.level===t?t:setFilteringMode(e.hostname,e.level))).then((e=>{registerInjectables(),s(e)})),!0;case"getDefaultFilteringMode":return getDefaultFilteringMode().then((e=>{s(e)})),!0;case"setDefaultFilteringMode":return getDefaultFilteringMode().then((t=>setDefaultFilteringMode(e.level).then((e=>({beforeLevel:t,afterLevel:e}))))).then((({beforeLevel:e,afterLevel:t})=>{1!==e&&1!==t||updateDynamicRules(),t!==e&&registerInjectables(),s(t)})),!0;case"setTrustedSites":return setTrustedSites(e.hostnames).then((()=>(registerInjectables(),Promise.all([getDefaultFilteringMode(),getTrustedSites()])))).then((e=>{s({defaultFilteringMode:e[0],trustedSites:Array.from(e[1])})})),!0;case"excludeFromStrictBlock":return excludeFromStrictBlock(e.hostname,e.permanent).then((()=>{s()})),!0;case"getMatchedRules":return getMatchedRules(e.tabId).then((e=>{s(e)})),!0;case"showMatchedRules":windows.create({type:"popup",url:`/matched-rules.html?tab=${e.tabId}`})}return!1}}async function start(){await loadRulesetConfig();const e=getCurrentVersion(),t=e!==rulesetConfig.version;t&&(ubolLog(`Version change: ${rulesetConfig.version} => ${e}`),rulesetConfig.version=e,await patchDefaultRulesets(),saveRulesetConfig());!1===(!1===process.wakeupRun&&await enableRulesets(rulesetConfig.enabledRulesets))&&(t?updateDynamicRules():!1===process.wakeupRun&&updateSessionRules());const s=await onPermissionsRemoved();if(!1===process.wakeupRun||s){registerInjectables();const e=await dnr.getEnabledRulesets();ubolLog(`Enabled rulesets: ${e}`),dnr.getAvailableStaticRuleCount().then((e=>{ubolLog(`Available static rule count: ${e}`)}))}if(process.wakeupRun,runtime.onMessage.addListener(onMessage),browser.permissions.onRemoved.addListener((()=>{onPermissionsRemoved()})),process.firstRun){if(await hasOmnipotence()){await setDefaultFilteringMode(MODE_OPTIMAL)===MODE_OPTIMAL&&(updateDynamicRules(),registerInjectables(),process.firstRun=!1)}else{!0!==await adminRead("disableFirstRunPage")||(process.firstRun=!1)}}toggleDeveloperMode(rulesetConfig.developerMode),!1===process.wakeupRun&&adminReadEx("disabledFeatures")}start().then((()=>(localRemove("goodStart"),!1))).catch((e=>{if(console.trace(e),!process.wakeupRun)return localRead("goodStart").then((e=>!1===e?(localRemove("goodStart"),!1):localWrite("goodStart",!1).then((()=>!0))))})).then((e=>{!0===e&&runtime.reload()}));