import{dom,qs$,qsa$}from"./dom.js";import{i18n,i18n$}from"./i18n.js";import{localRead,localWrite,sendMessage}from"./ext.js";export const rulesetMap=new Map;let cachedRulesetData={},hideUnusedSet=new Set(["regions"]);function renderNumber(e){return e.toLocaleString()}function renderTotalRuleCounts(){let e=0,t=0,s=0;for(const o of qsa$('#lists .listEntry[data-role="leaf"][data-rulesetid]')){if(null===qs$(o,'input[type="checkbox"]:checked'))continue;e+=1;const n=rulesetStats(o.dataset.rulesetid);void 0!==n&&(s+=n.ruleCount,t+=n.filterCount)}dom.text("#listsOfBlockedHostsPrompt",i18n$("perRulesetStats").replace("{{ruleCount}}",renderNumber(s)).replace("{{filterCount}}",renderNumber(t))),dom.cl.toggle(dom.body,"noMoreRuleset",e===cachedRulesetData.maxNumberOfEnabledRulesets)}function updateNodes(e){e=e||qs$("#lists");const t=".listEntry[data-rulesetid] > .detailbar input",s=`${t}:checked`;for(const o of qsa$(e,".listEntry[data-nodeid]")){const e=qs$(o,":scope > .detailbar .count");if(null===e)continue;const n=qsa$(o,t).length,d=qsa$(o,s).length;dom.text(e,`${d}/${n}`);const l=qs$(o,":scope > .detailbar .checkbox");if(null===l)continue;const i=qs$(l,"input");dom.prop(i,"checked",0!==d),dom.cl.toggle(l,"partial",0!==d&&d!==n);const a=qsa$(o,".listEntry.fromAdmin[data-rulesetid] > .detailbar input").length===n;dom.cl.toggle(o,"fromAdmin",a),dom.attr(i,"disabled",a?"":null)}}function rulesetStats(e){const t=cachedRulesetData.defaultFilteringMode>1,s=rulesetMap.get(e);if(void 0===s)return;const{rules:o,filters:n}=s;let d=o.plain+o.regex;t&&(d+=o.removeparam+o.redirect+o.modifyHeaders);return{ruleCount:d,filterCount:n.accepted}}function isAdminRuleset(e){const{adminRulesets:t=[]}=cachedRulesetData;for(const s of t){const t=s.indexOf(e);if(0===t)return!0;if(1!==t)continue;const o=s.charAt(0);if("+"===o||"-"===o)return!0}return!1}export function renderFilterLists(e){cachedRulesetData=e;const{enabledRulesets:t,rulesetDetails:s}=cachedRulesetData,o=0!==rulesetMap.size;s.forEach((e=>rulesetMap.set(e.id,e)));const n=i18n$("perRulesetStats"),d=(e,s)=>{const o=t.includes(e.id);!1===dom.cl.has(s,"toggled")&&dom.prop(qs$(s,":scope > .detailbar input"),"checked",o),e.homeURL&&dom.attr(qs$(s,"a.support"),"href",e.homeURL),dom.cl.toggle(s,"isDefault","default"===e.id);const d=rulesetStats(e.id);if(void 0===d)return;s.title=n.replace("{{ruleCount}}",renderNumber(d.ruleCount)).replace("{{filterCount}}",renderNumber(d.filterCount));const l=isAdminRuleset(e.id);dom.cl.toggle(s,"fromAdmin",l);const i=0===d.ruleCount||l;dom.attr(qs$(s,".input.checkbox input"),"disabled",i?"":null)};if(o){for(const e of qsa$("#lists .listEntry[data-rulesetid]")){const t=e.dataset.rulesetid,s=rulesetMap.get(t);d(s,e)}return updateNodes(),void renderTotalRuleCounts()}const l=(e,t)=>void 0===e.lists?dom.clone('#templates .listEntry[data-role="leaf"]'):0!==t?dom.clone('#templates .listEntry[data-role="node"]'):dom.clone('#templates .listEntry[data-role="rootnode"]'),i=(e,t,s=0)=>{const o=dom.clone("#templates .listEntries"),n=Object.entries(t);if(0!==s){const e=/\p{Emoji}+/gu;n.sort(((t,s)=>{const o=!0===t[1].preferred;if(o!==(!0===s[1].preferred))return o?-1:1;const n=(t[1].title||t[0]).replace(e,""),d=(s[1].title||s[0]).replace(e,"");return n.localeCompare(d)}))}for(const[e,t]of n){const n=l(t,s);void 0===t.lists?n.dataset.rulesetid=e:(n.dataset.nodeid=e,dom.cl.toggle(n,"hideUnused",hideUnusedSet.has(e))),qs$(n,":scope > .detailbar .listname").append(i18n.patchUnicodeFlags(t.name)),void 0!==t.lists?(n.append(i(e,t.lists,s+1)),dom.cl.toggle(n,"expanded",!0)):d(t,n),o.append(n)}return o},a=new Map([["default",s.filter((e=>"default"===e.id||"default"===e.group))],["malware",s.filter((e=>"malware"===e.group))],["annoyances",s.filter((e=>"annoyances"===e.group))],["misc",s.filter((e=>"default"!==e.id&&void 0===e.group&&"string"!=typeof e.lang))],["regions",s.filter((e=>"regions"===e.group))]]);dom.cl.toggle(dom.body,"hideUnused",mustHideUnusedLists("*"));const r={},c=new Map;for(const[e,t]of a){let s=c.get(e);void 0===s&&(s=i18n$(`3pGroup${e.charAt(0).toUpperCase()}${e.slice(1)}`),c.set(e,s));const o={name:s,lists:{}};r[e]=o;for(const e of t)if(void 0!==e.parent){let t=o.lists;for(const s of e.parent.split("|"))void 0===t[s]&&(t[s]={name:s,lists:{}}),t=t[s].lists;t[e.id]=e}else o.lists[e.id]=e}const u=(e,t=0)=>{if(!1===Boolean(e.lists))return e;const s=Object.keys(e.lists);for(const o of s){const s=u(e.lists[o],t+1);s!==e.lists[o]&&(e.lists[s.id]=s,delete e.lists[o])}return 0===t||s.length>1?e:e.lists[s[0]]};for(const e of Object.keys(r))u(r[e]);const p=i("root",r);updateNodes(p),dom.clear("#lists"),qs$("#lists").append(p),renderTotalRuleCounts()}function mustHideUnusedLists(e){const t=hideUnusedSet.has("*");return"*"===e?t:hideUnusedSet.has(e)!==t}function toggleHideUnusedLists(e){const t=hideUnusedSet.has("*");if("*"===e){const s=!1===t;hideUnusedSet.clear(),s&&hideUnusedSet.add(e),dom.cl.toggle("#lists","hideUnused",s),dom.cl.toggle(".listEntry[data-nodeid]","hideUnused",s)}else{const s=hideUnusedSet.has(e);s?hideUnusedSet.delete(e):hideUnusedSet.add(e);const o=s===t,n=`.listEntry[data-nodeid="${e}"]`;dom.cl.toggle(n,"hideUnused",o)}localWrite("hideUnusedFilterLists",Array.from(hideUnusedSet))}dom.on("#lists","click",".listEntry[data-nodeid] > .detailbar, .listExpander",(e=>{toggleHideUnusedLists(dom.attr(e.target.closest("[data-nodeid]"),"data-nodeid"))})),localRead("hideUnusedFilterLists").then((e=>{if(!1!==Array.isArray(e)){hideUnusedSet=new Set(e);for(const e of qsa$("[data-nodeid]"))dom.cl.toggle(e,"hideUnused",hideUnusedSet.has(e.dataset.nodeid))}}));const searchFilterLists=()=>{const e=dom.prop("#findInLists","value")||"";if(dom.cl.toggle("#lists","searchMode",""!==e),""===e)return;const t=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i");for(const e of qsa$('#lists [data-role="leaf"]')){if(dom.cl.has(e,"fromAdmin"))continue;const s=e.dataset.rulesetid,o=rulesetMap.get(s);if(void 0===o)continue;let n=perListHaystack.get(o);void 0===n&&(n=[o.name,e.dataset.nodeid,o.group||"",o.tags||""].join(" ").trim(),perListHaystack.set(o,n)),dom.cl.toggle(e,"searchMatch",t.test(n))}for(const e of qsa$('#lists .listEntry:not([data-role="leaf"])'))dom.cl.toggle(e,"searchMatch",null!==qs$(e,".listEntries .listEntry.searchMatch"))},perListHaystack=new WeakMap;dom.on("#findInLists","input",searchFilterLists);const applyEnabledRulesets=(()=>{const e=async()=>{const e=[];for(const t of qsa$('#lists .listEntry[data-role="leaf"][data-rulesetid]')){if(!1===(null!==qs$(t,'input[type="checkbox"]:checked')))continue;const{rulesetid:s}=t.dataset;dom.cl.has(t,"fromAdmin")||e.push(s)}dom.cl.remove("#lists .listEntry.toggled","toggled"),0!==e.length&&await sendMessage({what:"applyRulesets",enabledRulesets:e})};let t;return self.addEventListener("beforeunload",(()=>{void 0===t&&(self.clearTimeout(t),t=void 0,e())})),function(){void 0!==t&&self.clearTimeout(t),t=self.setTimeout((()=>{t=void 0,e()}),997)}})();dom.on("#lists","change",'.listEntry input[type="checkbox"]',(e=>{const t=e.target,s=t.closest(".listEntry");if(null!==s){if(void 0!==s.dataset.nodeid){const e=t.checked||dom.cl.has(qs$(s,":scope > .detailbar .checkbox"),"partial");for(const t of qsa$(s,":scope > .listEntries .listEntry[data-rulesetid]"))dom.cl.add(t,"toggled"),dom.prop(qsa$(t,":scope > .detailbar input"),"checked",e)}else dom.cl.add(s,"toggled");updateNodes(),renderTotalRuleCounts(),applyEnabledRulesets()}}));