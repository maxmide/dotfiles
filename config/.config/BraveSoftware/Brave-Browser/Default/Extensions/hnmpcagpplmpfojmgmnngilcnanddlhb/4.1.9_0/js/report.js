import{dnr,runtime}from"./ext.js";import{dom,qs$}from"./dom.js";import{sendMessage}from"./ext.js";const reportedPage=(()=>{const e=new URL(window.location.href);try{const t=e.searchParams.get("url");if(null===t)return null;const r=new URL(t);r.username="",r.password="",r.hash="";const s=qs$('select[name="url"]');if(dom.text(s.options[0],r.href),""!==r.search){const e=dom.create("option");r.search="",dom.text(e,r.href),s.append(e)}if("/"!==r.pathname){const e=dom.create("option");r.pathname="",dom.text(e,r.href),s.append(e)}return{hostname:r.hostname.replace(/^(m|mobile|www)\./,""),mode:e.searchParams.get("mode")}}catch(e){}return null})();function reportSpecificFilterType(){return qs$('select[name="type"]').value}function renderData(e,t=0){const r=" ".repeat(t);if(Array.isArray(e)){const r=[];for(const s of e)r.push(renderData(s,t));return r.join("\n")}if("object"!=typeof e||null===e)return`${r}${e}`;const s=[];for(const[o,a]of Object.entries(e))"object"!=typeof a||null===a?s.push(`${r}${o}: ${a}`):(s.push(`${r}${o}:`),s.push(renderData(a,t+1)));return s.join("\n")}async function reportSpecificFilterIssue(){const e=new URL("https://github.com/uBlockOrigin/uAssets/issues/new?template=specific_report_from_ubol.yml"),t=reportSpecificFilterType();let r=`${reportedPage.hostname}: ${t}`;qs$("#isNSFW").checked&&(r=`[nsfw] ${r}`),e.searchParams.set("title",r),e.searchParams.set("url_address_of_the_web_page","`"+qs$('select[name="url"]').value+"`"),e.searchParams.set("category",t);const s=runtime.getManifest(),o=await dnr.getEnabledRulesets(),a=await sendMessage({what:"getDefaultFilteringMode"}),n=["no filtering","basic","optimal","complete"],i=["```yaml",renderData({version:`uBOL ${s.version}`,mode:`${n[reportedPage.mode]} / ${n[a]}`,rulesets:o}),"```",""].join("\n");e.searchParams.set("configuration",i),sendMessage({what:"gotoURL",url:e.href})}(async()=>{dom.on("[data-url]","click",(e=>{const t=e.target.closest("[data-url]"),r=dom.attr(t,"data-url");"string"==typeof r&&""!==r&&(sendMessage({what:"gotoURL",url:r}),e.preventDefault())})),null!==reportedPage&&(dom.on('[data-i18n="supportReportSpecificButton"]',"click",(e=>{reportSpecificFilterIssue(),e.preventDefault()})),dom.on('[data-i18n="supportFindSpecificButton"]',"click",(e=>{const t=new URL("https://github.com/uBlockOrigin/uAssets/issues");t.searchParams.set("q",`is:issue sort:updated-desc "${reportedPage.hostname}" in:title`),sendMessage({what:"gotoURL",url:t.href}),e.preventDefault()})))})();